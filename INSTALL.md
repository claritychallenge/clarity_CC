# CLARITY CEC1 - INSTALLATION + USAGE

The following instructions explain how to install and use the CEC1 software.

The software has been tested on Mac OS and Linux systems, but if you experience any problems please [contact us](http://claritychallenge.org/sign-up-to-the-challenges) or post a query to the challenge [Google group](https://groups.google.com/g/clarity-challenge?pli=1).

## 0. Prerequisites

You will need,

- Python (3.7 or more recent)
- ~300 GB of disk space
- Various command-line tools and utilities, e.g., sox, wget.

Visit the `install/` directory. 

- If you are using an Ubuntu linux system, you should be able to install all necessary prerequisites by running `install_prerequisites.ubuntu.sh`
- If you are using a Mac, things are a little more experimental. Please see `install_prerequisites.macos.sh` and read the comments before running.

Once these prerequisites are installed the remaining instructions should be common for Mac and linux.

## 1. Installation

Visit the `install/` directory and run the `install.sh` script.

```bash
cd install
./install.sh
```

This script will perform three actions:

- Download third-party Head-Related Impulse Response (HRIR) data that is used in the pipeline.
- Set up a Python virtual environment and install required Python packages.
- Download and attempt to install the third-party openMHA hearing aid software.

Note, openMHA is used to provide the baseline hearing aid signal processing. It is not needed if you just want to generate the development and training data hearing aid input signals.

## 2. Test the installation

The software has a small amount of inbuilt test data that can now be used to test the installation.

Top level scripts for running the tools are stored in the `scripts` directory.
First, use `check_data.sh` to check that that the test data is present,

```bash
cd scripts
./check_data.sh train
./check_data.sh dev
```

Now check that the scene generation code is working correctly. While still in the scripts directory,

```bash
./generate.sh --num_channels 3 train
./generate.sh --num_channels 3 dev
```

If the openMHA software has installed correctly you will also be able to test the baseline hearing aid processing,

```bash
./enhance.sh --num_channels 3 dev
```

The outputs for the scene generation and hearing aid processor can be found in the directory  `<CLARITY_ROOT>/data/clarity_data/train/scenes` and `<CLARITY_ROOT>/data/clarity_data/dev/scenes`. In the train directory there will be outputs for scene `S00001` and in the dev directory outputs for scene `S06000`.

## 3. Install the challenge data

The challenge data is a 60 GB download and provides the material necessary to build the 6,000 scene official training set and 2,500 scene official development set.

First, visit the [download site](https://mab.to/I9mkGx4wsiiaX) and download the following data packs

- `clarity_CEC1_data.main.v1_0.tgz`  [58 GB]

To download: click on the file to select it and then click on the download icon in the top-right of the interface. Select 'As individual files'. (The site also lists datapacks for 'premixed' scenes. You do no need to download these as they will be generated by the software.)

Unpack the data into a root directory of your choosing using

```bash
cd install
./unpack.sh <DOWNLOAD_DIR>/clarity_CEC1_data.main.v1_0.tgz <TARGET_DIR>
```

where `DOWNLOAD_DIR` is the location of the download and `<TARGET_DIR>` is the desired location of the unpacked data. The script will produce a directory `<TARGET_DIR>/clarity_CEC1_data` containing the data.

Note, `<TARGET_DIR>` should be on a device with at least 330 GB of free storage. The `.tgz` unpacks to around 80 GB and a further 240 GB will be generated when the scene generation runs.

IMPORTANT: Do not untar the package by hand. The `unpack.sh` script does more than just untarring, it also adds a couple of important symbolic links between the data directory and the software directory, and copies a missing metadata file into the correct location. Read the script if you are unsure.

## 4. Generate the scene data

You can now generate the full dataset by repeating the steps that were used with the test data.

It is advisable to check the data integrity before running the scene generation, i.e.,

```bash
cd scripts
./check_data.sh train
./check_data.sh dev
```

Errors will be reported if any files are missing. Presuming all is OK, you can now generate the scenes with

```bash
./generate.sh --num_channels 3 train
./generate.sh --num_channels 3 dev
```

This step will take about 6-8 hours.

## 5. Run the reference OpenMHA hearing aid

Run the reference hearing aid on the generated scenes using

```bash
./enhance.sh --num_channels 3 dev
```

## 6. Generate predicted intelligibility scores

A reference objective intelligibility measure is being provided. This measure is based on a combination of a hearing loss model and the MBSTOI intelligibility score. It will be used to select systems to present to the listening panel in the event that there are too many entrants for all to be assessed via listening tests (see Challenge rules).

To evaluate the output of the reference hearing aid use,

```bash
./predict.sh dev
```

Note, the `predict.sh` will take a long time to run completely. For each scene, intelligibility predictions for three different listeners are generated. The script can be safely stopped at any stage and outputs for scenes processed so far will appear appended to a file called `sii.txt` in `<CLARITY_ROOT>/data/clarity_data/train/scenes` or `<CLARITY_ROOT>/data/clarity_data/dev/scenes`.

There is a script `run_all.sh` that runs all of the above steps.

## Appendices

### A. Downloading pre-computed scene data

(Note, **this option is discouraged** because the downloads are large and it will probably be faster to run the `generate.sh` script.)

If you are unable to run the scene generation code, then pre-generated scenes can be downloaded directly. The data is available at the same download address. There are three files:

```bash
clarity_CEC1_data.scenes_dev.v1_1.tgz  [59 GB] -- targets, mixtures and interferers
clarity_CEC1_data.scenes_train.part1.v1_1.tgz [90 GB]  -- targets and mixtures
clarity_CEC1_data.scenes_train.part2.v1_1.tgz [47 GB]  -- interferers
```

Once they are downloaded they can be unpacked into the correct place with,

```bash
tar -xvzf -C <TARGET_DIR> -k clarity_CEC1_data.scenes_dev.v1_1.tgz
```

where `TARGET_DIR` is the location at which you installed the main Clarity data package (see stage 3 above).

### B. Data directory structure

After the scene generation stage has run, the data directory structure should look like this

```bash
.
├── clarity_data
│   ├── metadata
│   │   └── schemas
│   ├── hrir@
│   │       └── HRIRs_MAT
│   ├── train
│   │   ├── interferers
│   │   │   ├── noise
│   │   │   └── speech
│   │   ├── rooms
│   │   │   ├── ac
│   │   │   ├── brir
│   │   │   └── rpf
│   │   ├── scenes # your output folder
│   │   └── targets
│   ├── dev
│   │   ├── interferers
│   │   │   ├── noise
│   │   │   └── speech
│   │   ├── rooms
│   │   │   ├── ac
│   │   │   ├── brir
│   │   │   └── rpf
│   │   ├── scenes # your output folder
│   │   └── targets
│   └── ...
└── ...
```

### C. Information on default parameter values

Outside of module testing via pytest tests, parameter values are set via `clarity.cfg`.

The default sampling rate is 44.1 kHz. The default output gain constant is 1.
The default pre-duration and post-duration interferer periods are 2.0 and 1.0 (s),
repectively. This means that the interferer starts 2 seconds before the target speech,
and ends 1 second afterwards. The reverberation tail duration is 0.2 (s). The default
duration of the ramp into and out of the interferer signal sampled for each scene
is 0.5 (s).

The GHA and MSBG modules have parameter settings as follows: the default centre
frequencies for the audiograms are [250, 500, 1000, 2000, 3000, 4000, 6000, 8000],
as these are used in the listener data provided.

In our implementation, the CAMFIT prescription used in the GHA module sets parameter
noisegatelevels (compression thresholds) to the band levels for a speech-shaped
noise signal with an overall level of 45 dB SPL: [38, 38, 36, 37, 32, 26, 23, 22, 8].
There is a one-to-one input-output gain relationship below the compression threshold,
hence for GHA parameter noisegateslope is set to 0. The input level for compression ratio
calculation, parameter cr_level, is set to 0, indicating that it varies depending
on insertion gains. The prescription is set to have a maximum output level, parameter
max_output_level, of 100 dB SPL. The default configuration file for GHA is set to
'prerelease_combination3_smooth'.

In the baseline, a convention is used to estimate the level of signals as they pass through 
the pipeline: that a +/-1 square wave has RMS = 0dB (full scale or FS). Further, up
to the point of signals being produced by the GHA module, the convention is that 0 dB FS
is equal to 100 dB SPL. See parameter equiv0dBSPL. From that point onwards, as GHA
provides 20 dB of amplification headroom (parameter ahr), the convention is that 0 dB FS
is equal to 120 dB SPL. The MSBG signal processing relies on knowing the true input level
in dB SPL.

In the creation of the provided scene metadata, signal-to-noise ratios (SNRs) were pseudo-
randomly sampled from the ranges [0,12] dB for speech interferers, and [-6,6] dB for non-
speech interferers. Three listeners are assigned to each scene.

### D. Baseline module testing

In each module, e.g., 'clarity_CEC1/projects/GHA', tests can be run as follows:

```bash

pytest tests
```

Ensure that CLARITY_ROOT is set correctly. See scripts/paths.sh.
Add --regtest-reset if running for the first time.
